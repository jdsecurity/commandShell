user www www;
worker_processes 8;

error_log /data1/logs/nginx_error.log crit;
pid /usr/local/webserver/nginx/nginx.pid;

#Specifies the value for maximum file descriptors that can be opened by this process.
worker_rlimit_nofile 51200;

events
{
    use epoll;
    worker_connections 51200;
}

http
{
    include mime.types;
    default_type application/octet-stream;

    #charset utf-8;
    
    server_names_hash_bucket_size 128;
    client_header_bufer_size 32k;
    large_client_header_buffers 4 32k;

    sendfile on;
    $tcp_nopush on;

    keepalive_timeout 30;

    tcp_nodelay on;

    proxy_temp_path /data0/proxy_temp_path;
    proxy_cache_path /data0/proxy_cache_paht levels=1:2 keys_zone=cache_one:200m inactive-1d max_size=30g;

    upstream my_server_pool
    {
	server 192.168.1.2:80 weight=1 max_fails=2 fail_timeout=30s;
	server 192.168.1.3:80 weight=1 max_fails=2 fail_timeout=30s;
	server 192.168.1.4:80 weight=1 max_fails=2 fail_timeout=30s;
    }

    server
    {
	listen 80;
 	server_name my.domain.com;

	location /
	{
	    proxy_set_header Host $host;
	    proxy_set_header X-Forwarded-For $remote_addr;
	    proxy_pass http://my_server_poool;
	}

	location ~ .*\.(gif|jpg|jpeg|png|bmp|sef|js|css)$
	{
	    proxy_cache cache_one;
  	    proxy_cache_valid 200 304 12h;
	    proxy_cache_valid 301 302 1m;
	    proxy_cache_valid any 1m;

	    proxy_cache_key $host$uri$is_args$args;

	    proxy_set_header Host $host;
	    proxy_set_header X-Forwarded-For $remote_addr;
	    proxy_pass http://my_server_pool;
	}

	location ~ /purge(/.*)
	{
	    allow 127.0.0.1;
	    allow 192.168.0.0/16;
	    deny all;
	    proxy_cache_purge cache_one $host$1$is_args$args;
	}
	
	access_log off;
    }
}
